---
title: "DSTI Survey"
output:
     html_document:
        toc: true
        toc_float: true 
---

# Preamble

```{r setup}
library(tidyverse)
library(lubridate)
library(broom)
library(survival)

as_tibble.survfit <- function(x, ...) {
  tibble(
    time = c(0, x$time),
    surv = c(1, x$surv),
    incidence = 1 - surv
  )
}

get_surv_table <- function(time, status) {
  survfit(Surv(time, status) ~ 1) %>%
    as_tibble() %>%
    list()
}
```

# Data Import

## A first look

```{r}
d_raw <- read_csv("DSTI_survey.csv")

d_raw
```

## Cohort
```{r}
barplot(table(d_raw$Cohort))
```

```{r}
cohort_levels <- paste(c("S", "A"), rep(15:20, each = 2), sep = "")
cohort_levels
```


```{r}
d0 <- d_raw |>
  mutate(
    cohort = factor(Cohort, levels = cohort_levels)
  )

table(d0$cohort)
```
```{r}
barplot(table(d0$cohort))
```

## Educational background

```{r}
table(d_raw$`Education: background (pick a main one you identify with)`)
```
### Abbreviations lookup table
```{r}
edu_labels <- tibble(
  `Education: background (pick a main one you identify with)` =
    c("Business, Management", "Finance, Economy",
      "Literature, History, Philosophy", 
      "Mathematics, Physics, Chemistry, Computer Science, Statistics", 
      "Medicine, Biology", "Other"),
  education = c("mgmt", "fin", "lit", "math", "bio", "oth")
  )
```

```{r}
d1 <-
  d_raw |>
  inner_join(
    edu_labels,
    by = "Education: background (pick a main one you identify with)"
  )
table(d1$education)
```

## Time To Internship

```{r}
d_duration <-
  d_raw |>
  select(
    Timestamp,
    `Have you found an internship?`,
    `When did you start looking for an internship`,
    `When did you stopped looking for an internship`
  )
d_duration
```

```{r}
table(d_duration$`Have you found an internship?`, useNA = "always")
```

```{r}
d_duration_1 <-
  d_raw |>
  transmute(
    Timestamp =
      as.Date(
        Timestamp,
        format = "%m/%d/%Y %H:%M:%S",
        origin = "1970-01-01"),

    intEver = `Have you found an internship?` == "Yes",

    intStart =
      as.Date(`When did you start looking for an internship`,
              format = "%m/%d/%Y",
              origin = "1970-01-01"),
    intStop =
      as.Date(
        `When did you stopped looking for an internship`,
        format = "%m/%d/%Y",
        origin = "1970-01-01")

  )
d_duration_1
```

```{r}
summary(d_duration_1)
```

```{r}
d_duration_2 <-
  d_duration_1 |>
  mutate(
    intStop =
      as.Date(ifelse(is.na(intStop), Timestamp, intStop), origin = "1970-01-01"),

    tti_m = as.numeric(difftime(intStop, intStart, units = "days")) / 30.5,

    status = intEver)

summary(d_duration_2)
```

```{r}
filter(d_duration_2, tti_m >= 0) |>
  summary()
```

## All variables
```{r}
d <-
  read_csv("DSTI_survey.csv") |>
  inner_join(edu_labels, by = "Education: background (pick a main one you identify with)") |>
  mutate(
    sex = factor(Sex, levels = c("Female", "Male")),
    cohort = factor(Cohort,
                    levels = paste0(c("S", "A"), rep(15:20, each = 2))),

    education = factor(education),
    edu_math = (education == "math") + 0,
    children = factor(`Do you have children?`, levels = c("No", "Yes")),
    
    cohort_year = 2000 + as.numeric(substring(as.character(cohort), first = 2)),

    pre_pandemic = factor(cohort_year < 2020, levels = c(FALSE, TRUE),
                          labels = c("No", "Yes")),

    intEver = `Have you found an internship?` == "Yes",

    Timestamp =
      as.Date(
        Timestamp,
        format = "%m/%d/%Y %H:%M:%S",
        origin = "1970-01-01"),
  
    age = year(Timestamp) - `Year of birth`,

    intStart =
      as.Date(
        `When did you start looking for an internship`,
        format = "%m/%d/%Y",
        origin = "1970-01-01"),

    intStop =
      as.Date(
        `When did you stopped looking for an internship`,
        format = "%m/%d/%Y",
        origin = "1970-01-01")
    ) |>
  mutate(
    intStop =
      as.Date(
        ifelse(is.na(intStop), Timestamp, intStop),
          origin = "1970-01-01"),
      tti_m = as.numeric(difftime(intStop, intStart, units = "days")) / 30.5,
      status = intEver
  ) |>
  select(tti_m, status, age, sex,
         cohort, pre_pandemic,
         education, edu_math,
         children) |>
  filter(tti_m >= 0)
```

```{r}
d
```


```{r}
summary(d)
```


```{r}
arrange(d, desc(age))
```


```{r}
barplot(table(d$education))
```

# One-Sample, Nonparametric Data Analysis

## Summaries

```{r}
summary(d)
```

## Overall TTI
```{r}
fit <- survfit(Surv(tti_m, status) ~ 1, data = d)
plot(fit,
     fun = "F",
     xlab = "months",
     ylab = "Cumulated Probability of finding an internship")
```
### Median TTI
```{r}
fit
```

Half of the survey respondents found an internship within 2.2 months (95% CI: 1.97-5.02).

### Probability of Internship by 12 month
```{r}
sfit_12 <- summary(fit, time = 12)
sfit_12
```

```{r}
str(sfit_12)
with(sfit_12, tibble(P = 1-surv, P.L95 = 1 - upper, P.U95 = 1 - lower))
```

## Impact of demographics, educational background

```{r}
d |>
  select(age, sex, children, education) |>
  summary()
```

```{r}
d_age33 <-
  d |>
  mutate(age33 = factor(age <= 33,
                        levels = c(TRUE, FALSE),
                        labels = c("<=33", ">33")))

table(d_age33$age33)
```

### Sex
```{r}
sfit <- survfit(Surv(tti_m, status) ~ sex, data = d_age33)
sfit
plot(sfit, col = c("blue","green"), fun = "F",
     xlab = "time (months)",
     ylab = "Cumulated probability of internship")
```

### Age
```{r}
sfit <- survfit(Surv(tti_m, status) ~ age33, data = d_age33)
sfit
```

```{r}
plot(sfit, col = c("red","blue"), fun = "F",
     xlab = "time (months)",
     ylab = "Cumulated probability of internship")
```

### Children

```{r}
survfit(Surv(tti_m, status) ~ children, data = d)
```

```{r}
plot(sfit, col = c("red","blue"), fun = "F",
     xlab = "time (months)",
     ylab = "Cumulated probability of internship")
```

```{r}
with(d_age33, table(age33, children))
```

### Age AND Children
```{r}
d_age33 |>
  group_by(children, age33) |>
  summarize(surv = get_surv_table(tti_m, status)) |>
  unnest(surv) |>
  ggplot(aes(x = time, y = incidence, color = children)) +
    geom_step(lwd = 2) +
    facet_grid(~ age33) +
    xlab("time (months)") +
    ylab("cumulated probability\nof finding an internship") +
    theme_bw(base_size = 18) +
    theme(legend.pos = "top")
```

```{r}
sfit <- survfit(Surv(tti_m, status) ~ age33 + children, data = d_age33)
sfit
```

```{r}
plot(sfit, col = c("black", "gray", "red", "blue"), fun = "F", lwd = 2)
```

### Educational Background

```{r}
table(d$education)
```

```{r}
d_edu <-
  d_age33 |>
  mutate(edu2 = factor(education %in% c("math", "fin"),
                        levels = c(TRUE, FALSE),
                        labels = c("math", "other")))
with(d_edu, table(education, edu2))
```

```{r}
table(d_edu$edu2)
```

```{r}
sfit <- survfit(Surv(tti_m, status) ~ edu2, data = d_edu)
sfit
```

```{r}
plot(sfit, col = c("red","blue"))
```

# Comparing two or more groups

## Sex
```{r}
survdiff(Surv(tti_m, status) ~ sex, data = d_age33)
```


## Age
```{r}
survdiff(Surv(tti_m, status) ~ age33, data = d_age33)
```


## Children
```{r}
survdiff(Surv(tti_m, status) ~ children, data = d_age33)
```

## Education
```{r}
survdiff(Surv(tti_m, status) ~ edu2, data = d_edu)
```

# Regression Analysis

## Quantiative effects of Age, Sex, Children, Education

### Age - binary
```{r}
coxph(Surv(tti_m, status) ~ age33, data = d_age33) |>
  tidy(conf.int = TRUE) |>
  mutate(HR = exp(estimate))
```

### Age - continuous
```{r}
coxph(Surv(tti_m, status) ~ I(age/10), data = d) |>
  tidy(conf.int = TRUE) |>
  mutate(HR = exp(estimate))
```

### Age, Sex, Children, Education - summary

```{r}
names(d_edu)
```

```{r}
get_estimates <- function(v_name) {
  d_v <- d_edu
  d_v$x <- d_v[[ v_name ]]
  coxph(Surv(tti_m, status) ~ x, data = d_v) |>
    tidy(conf.int = TRUE) |>
    mutate(covariate = v_name) |>
    relocate(covariate)
}
```

```{r}
get_estimates("age33")
```

```{r}
vars_list <- c("age33", "sex", "children", "edu2")
summary_table <- map_dfr(vars_list, get_estimates)
summary_table
```

```{r}
summary_table |>
  transmute(
    covariate, term,
    HR = exp(estimate),
    HR.L95 = exp(conf.low),
    HR.U95 = exp(conf.high)
  )
```

### A (minimalistic) Forest Plot

```{r}
tmp <-
  summary_table |>
  transmute(
    covariate, term,
    HR = exp(estimate),
    HR.L95 = exp(conf.low),
    HR.U95 = exp(conf.high)
  )
ggplot(tmp, aes(x = HR, y = paste(covariate, term))) +
  geom_errorbarh(aes(xmin = HR.L95, xmax = HR.U95)) +
  geom_point() +
  geom_vline(xintercept = 1, lty = 2) +
  theme_bw() +
  xlab("Hazard Ratio") +
  ylab(NULL)
```

## Multiple Covariates

### Age + Sex
```{r}
coxph(Surv(tti_m, status) ~ I(age/10) + sex, data = d) |>
  summary()
```

### Age + Children
```{r}
coxph(Surv(tti_m, status) ~ I(age/10) + children, data = d) |>
  summary()
```

```{r}
coxph(Surv(tti_m, status) ~ age33 + children, data = d_edu) |>
  summary()
```

# Model-based Predictions

## Fitted Model
```{r}
M <- coxph(Surv(tti_m, status) ~ age + sex + children, data = d)
summary(M)
```
## New Data

New data points for which we want to extract predictions:
```{r}
d_new <- tribble(
  ~name,     ~age,  ~sex,     ~children,
  "Antonio",   38,   "Male",      "Yes",
  "Carine",    40,  "Female",      "No"
)
d_new
```

## Relative predictions

```{r}
d_new$score <- predict(M, newdata = d_new, type = "lp")
d_new
```

## Absolute predictions

### Median TTI
```{r}
sfit <- survfit(M, newdata = d_new)
sfit
```

### Individualized, model-based survival curves
```{r}
plot(sfit, col = 1:2, fun = "F",
     xlab = "time (months)",
     ylab = "Cumulated Probability of\nFinding an Internship")
legend("bottomright", legend = d_new$name, lty = 1, col = 1:2)
```
### Probability at given time points

```{r}
TIME <- 6 ## months

d_antonio <- tibble(age = 38, sex = "Female", children = "Yes")
surv.antonio <- survfit(M, newdata = d_antonio)
surv.antonio.t <- summary(surv.antonio, time = TIME)
surv.antonio.t
1 - surv.antonio.t$surv
```
