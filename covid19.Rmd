---
title: "COVID-19 analysis based on crowdsourced data"
output:
     html_document:
        toc: true
        toc_float: true 
---

[Data source](https://docs.google.com/spreadsheets/d/e/2PACX-1vQU0SIALScXx8VXDX7yKNKWWPKE1YjFlWc6VTEVSN45CklWWf-uWmprQIyLtoPDA18tX9cFDr-aQ9S6/pubhtml)

Paper:
[Early epidemiological analysis of the coronavirus disease 2019 outbreak based on crowdsourced data: a population-level observational study](https://www.thelancet.com/journals/landig/article/PIIS2589-7500(20)30026-1/fulltext)

Date downloaded: 2020-03-11.
Latest data update: 2020-03-09 1PM EST.

DISCLAIMER:
Data quality is **very questionable**. As such, any conclusions will be very questionable too.
This is meant as a didactic exercise only. Students are invited to find better data and/or 
keep a very critical mindset while going through the results.

```{r, message =FALSE}
library(tidyverse)
library(broom)
```

# Data preparation

```{r}
d_realistic_first_shot <- read_csv("covid19.csv")
```
```{r}
head(d_realistic_first_shot,5)
```


```{r read data}
d_raw <- read_csv(
  file = "covid19.csv",
  col_types = cols(
    id = 'c',
    case_in = 'c',
    age = 'd',
    if_onset_approximated = 'l',
    international_traveler = 'l',
    domestic_traveler = 'l',
    traveler = 'l',
    `visiting Wuhan` = 'l',
    `from Wuhan` = 'l',
    .default = 'c'
  )
)
```
## data cleaning 
```{r screen pb}
problems(d_raw)
```


```{r data structure }
str(d_raw)
```


```{r remove pb data line }
d_raw <- d_raw[-2224,]
```

```{r}
table(d_raw$death)
```

```{r}
table(d_raw$gender, useNA = "always")
```

```{r hist age}
hist(d_raw$age)
abline(v = mean(d_raw$age),col ="red")
abline(v = median(d_raw$age),col ="blue")
summary(d_raw$age)
```

```{r}
x <- NA_character_
y <- c("0", "1/1/2020", "1", NA_character_, "1")
is.na(y)
```

```{r}
as_date <- function(x) as.Date(x, format = "%m/%d/%y")
d <-
  d_raw |>
  mutate(reporting_date = as_date(reporting_date),
         hosp_visit_date = as_date(hosp_visit_date),
         exposure_start = as_date(exposure_start),
         exposure_end = as_date(exposure_end),
         symptom_onset = as_date(symptom_onset),
         death_status = death != "0",
         death_date = as.Date(ifelse(!death %in% c("0", "1"), as.Date(death, format = "%m/%d/%y", origin = "1970-01-01"), NA), origin = "1970-01-01"),
         gender = factor(gender, levels = c("female", "male")))
```

```{r}
summary(d)
```

# Binary outcome

## Sex impact

### Contingency table
```{r}
with(d, table(death_status, gender))
with(d, round(100 * prop.table(table(death_status, gender), 2), 1))
```


### Logistic regression
```{r}
d_death_sex <- d |> select(death_status, gender) |> na.omit()
summary(d_death_sex)
```
```{r}
fit_death_sex <- glm(death_status ~ gender, data = d_death_sex, family = "binomial")
summary(fit_death_sex);
```

```{r}
coef(fit_death_sex)
```


beta[0] = -3.16
beta[1] = 0.508
exp(beta[1]) = OR[m vs f]
```{r}
exp(coef(fit_death_sex)[2])
```
The odds of death in males is 1.66 times the odds of death in females.

```{r}
glm(death_status ~ gender, data = d_death_sex, family = "binomial") |>
  tidy(conf.int = TRUE) |>
  transmute(
    term,
    OR = exp(estimate),
    OR.L = exp(conf.low),
    OR.U = exp(conf.high),
    p.value) |>
  write_csv("model1.csv") |> 
  print()
```

The OR of death for males compared to females is 1.66 (95% CI: [1.00-2.84]; pvalue=0.055).
At the 5% significance level (5% type-1 error, a.k.a. test size), there's NO SIGNIFICANT DIFFERFENCE in mortality between men and women.

A better report, ready for excel:
```{r}
glance(fit_death_sex) |>
  write_tsv("logistic_death_sex_glance.tsv") |>
  print()
```

```{r}
tidy(fit_death_sex, conf.int = TRUE) |>
  filter(term != '(Intercept)') |>
  transmute(
    term = "male vs female",
    estimate, std.error, p.value,
    OR = exp(estimate),
    OR.L95 = exp(conf.low),
    OR.U95 = exp(conf.high)) |>
  write_tsv('logistic_death_sex_coefficients.tsv') |>
  print()
```

## Age

### Age - categorical

```{r}
d_cat <-
  mutate(d,
    age_cat = factor(age > 70, levels = c(FALSE, TRUE),
                        labels = c("<=70", ">70")))

with(d_cat, table(death_status, age_cat))

glm(death_status ~ age_cat, data = d_cat, family = "binomial") |>
  tidy(conf.int = TRUE) |>
  mutate(OR = exp(estimate), OR.L95 = exp(conf.low), OR.U95 = exp(conf.high))
```

### Age - years (continuous)
```{r}
glm(death_status ~ age, data = d, family = "binomial") |>
  tidy(conf.int = TRUE) |>
  mutate(
    OR = exp(estimate),
    OR.L95 = exp(conf.low),
    OR.U95 = exp(conf.high)
  )
```

### Age - decades (continuous)

```{r}
d_ageDec <- mutate(d, age_decades = age / 10)
glm(death_status ~ age_decades, data = d_ageDec, family = "binomial") |>
  tidy(conf.int = TRUE) |>
  mutate(
    OR = exp(estimate),
    OR.L = exp(conf.low),
    OR.H = exp(conf.high)
  )
```

### Quantitative model-based predictions
```{r}
get_odds_of_death <- function(age) exp(-7.56 + 0.07989 * age)
get_prob_of_death <- function(age) plogis(-7.56 + 0.07989 * age)
```

```{r}
curve(100 * get_prob_of_death(x), from = 20, to = 80,
      xlab = "age (years)", ylab = "Prob. of death by COVID-19 (%)", frame = F)
```
## Combined effects of Age and Sex

```{r}
d_age_sex <- d |> transmute(death_status, age_decades = age / 10, gender)
```

### Age + Sex

```{r}
logistic_age_sex <-
  glm(death_status ~ age_decades + gender, data = d_age_sex, family = "binomial") |>
  tidy(conf.int = TRUE)
logistic_age_sex
```

### Sex-specific age effects

```{r}
d_males <- filter(d_age_sex, gender == "male")
glm(death_status ~ age_decades, data = d_males, family = "binomial") |>
  tidy(conf.int = TRUE) |>
  mutate(
    OR = exp(estimate),
    OR.L95 = exp(conf.low),
    OR.U95 = exp(conf.high)
  )
```

```{r}
d_females <- filter(d_age_sex, gender == "female")
glm(death_status ~ age_decades, data = d_females, family = "binomial") |>
  tidy(conf.int = TRUE) |>
  mutate(
    OR = exp(estimate),
    OR.L95 = exp(conf.low),
    OR.U95 = exp(conf.high)
  )
```
### Testing the difference between sex-specific age effects
```{r}
glm(death_status ~ age_decades + gender + age_decades:gender,
    data = d_age_sex, family = "binomial") |>
  tidy(conf.int = TRUE) |>
  mutate(
    OR = exp(estimate),
    OR.L95 = exp(conf.low),
    OR.U95 = exp(conf.high)
  )
```

## Beyond linear effects for Age 

### Smoothing spline
```{r, message=FALSE}
library(mgcv)
fit <- gam(death_status ~ s(age) + gender, data = d, family = "binomial")
```

```{r}
summary(fit)
```

```{r}
plot(fit)
```

### Quadratic term

```{r}
#library(splines)
fit <- glm(death_status ~ age + I(age^2) + gender, data = d, family = "binomial")
summary(fit)
```

### Piece-wise linear terms

```{r}
d2 <- mutate(d, age_70 = ifelse(age > 70, age - 70, 0))
```

```{r}
fit <- glm(death_status ~ age + age_70, data = d2, family = "binomial")
summary(fit)
```

From 0 to 70:
```{r}
exp(coef(fit)[2])
```

After 70:
```{r}
exp(sum(coef(fit)[2:3]))
```

### A different parametrization

```{r}
d3 <- mutate(d,
             age_l70 = ifelse(age <= 70, age, 70),
             age_g70 = ifelse(age > 70, age - 70, 0))
fit <- glm(death_status ~ age_l70 + age_g70, data = d3, family = "binomial")

summary(fit)
```

```{r}
exp(confint(fit)[2:3,])
```


```{r}
exp(logistic_age_sex$estimate)
```


# Continuous outcome: survival time

## Data Preparation

```{r}
as_date <- function(x) as.Date(x, format = "%m/%d/%y")
d_raw <- read_csv(
  file = "covid19.csv",
  col_types = cols(
    id = 'c',
    case_in = 'c',
    age = 'd',
    if_onset_approximated = 'l',
    international_traveler = 'l',
    domestic_traveler = 'l',
    traveler = 'l',
    `visiting Wuhan` = 'l',
    `from Wuhan` = 'l',
    .default = 'c'
  )
)
d <-
  d_raw |>
  mutate(reporting_date = as_date(reporting_date),
         hosp_visit_date = as_date(hosp_visit_date),
         exposure_start = as_date(exposure_start),
         exposure_end = as_date(exposure_end),
         symptom_onset = as_date(symptom_onset),
         death_status = death != "0",
         death_date = as.Date(ifelse(!death %in% c("0", "1"), as.Date(death, format = "%m/%d/%y", origin = "1970-01-01"), NA), origin = "1970-01-01"),
         gender = factor(gender, levels = c("female", "male")))
```


The measured duration will be from first symptom to date of data collection: March 10th, 2020
```{r}
names(d)
```
```{r}
d
```


```{r}
library(survival)
END_OF_STUDY <- as.Date("2020-03-10", format = "%Y-%m-%d", origin = "1970-01-01")
```

```{r}
d_surv <-
  d %>%
  filter(!is.na(symptom_onset), !is.na(death_status),
         !(is.na(death_date) & death_status)) %>%
  mutate(
    death_date = as.Date(ifelse(is.na(death_date), END_OF_STUDY, death_date), origin = "1970-01-01"),
    time = difftime(death_date, symptom_onset, units = "days")
  )
```

```{r}
d_surv |>
  select(symptom_onset, death_date, time, death_status) |>
  head(10) |>
  print()
```

```{r}
fit <- survfit(Surv(time, death_status) ~ 1, data = d_surv)
fit
plot(fit)
```

Let's zoom in:
```{r}
plot(fit, ylim = c(0.95, 1),
     xlab = "time (days)", ylab = "Survival(t)")
```
Cannot extract a median, 7 deaths out of 623 cases (~1.1%):
```{r}
fit
```

## Effect of sex
```{r graph summary}
fit <- survfit(Surv(time, death_status) ~ gender, data = d_surv)
fit
plot(fit, col = 1:2, ylim = c(0.96, 1))
```

```{r num summary}
survdiff(Surv(time, death_status) ~ gender, data = d_surv)
```

The p-value is large (p=0.2): the difference *is not* statistically significant.

```{r}
fit.cph <- coxph(Surv(time, death_status) ~ gender, data = d_surv)
summary(fit.cph)
```

```{r}
d1 <- mutate(d_surv, age_dec = age / 10)
fit.cph <- coxph(Surv(time, death_status) ~ I(age/10), data = d1)
summary(fit.cph)
```

## Age AND Sex

```{r}
fit.cph <- coxph(Surv(time, death_status) ~ age_dec + gender, data = d1)
summary(fit.cph)
```

```{r}
data_new <- data.frame(age_dec = 6.3, gender = "male")
pred <- survfit(fit.cph, new.data = data_new)
plot(pred, ylim = c(0.95, 1.0))
```

```{r}
summary(pred, time = 30)
```


## Country
```{r}
nrow(d_surv)
table(d_surv$country)
```

### Countries with 50+ samples

```{r}
num_cases <- d_surv |> count(country) |> arrange(desc(n))
num_cases
```

```{r}
top_countries <- filter(num_cases, n >= 50)
d_tc <- d_surv |> semi_join(top_countries, by = "country")
table(d_tc$country)
```

```{r}
sfit <- survfit(Surv(time, death_status) ~ I(country == "Japan"), data = d_tc)
sfit
plot(sfit, ylim = c(0.90, 1), col = 1:2)
```

```{r}
survdiff(Surv(time, death_status) ~ I(country == "Japan"), data = d_tc)
```

```{r}
d_tc$japan <- (d_tc$country == "Japan") + 0
summary(coxph(Surv(time, death_status) ~ japan, data = d_tc))
```


### Compare by sex, stratifying by country
```{r}
survdiff(Surv(time, death_status) ~ gender + strata(I(country == "Japan")), data = d_tc)
```


## Effects of covariates on risk of death

```{r}
summary(d_surv)
```

## Gender

```{r}
summary(coxph(Surv(time, death_status) ~ gender, data = d_surv))
```

## Country

Model does not converge: again, too few cases.
```{r}
summary(coxph(Surv(time, death_status) ~ country, data = d_surv))
```
Is risk in France really 1.8 **billion** times that in China?

## Age

This one is strong, as expected:
```{r}
summary(coxph(Surv(time, death_status) ~ I(age / 10), data = d_surv))
```

## Age - pspline

```{r}
fit_age <- coxph(Surv(time, death_status) ~ pspline(age, df = 4), data = d_surv)
summary(fit_age)
```

```{r}
termplot(fit_age, col.term = 1, col.se = 1)
```

## Age - piecewise-linear - A

Two segments: constant 0-70; increasing after 70

```{r}
e <-
  d_surv |>
  mutate(
    age_70p = ifelse(age <= 70, 0, age - 70)
  )
```

```{r}
fit_age_segments <- coxph(Surv(time, death_status) ~ age_70p, data = e)
summary(fit_age_segments)
```

Or more simply, before and after 70:
```{r}
fit_age_binary <- coxph(Surv(time, death_status) ~ I(age > 70), data = e)
summary(fit_age_binary)
```

Risk after 70yo is **40 times** that of people less than 70yo!
Let's see it visually:
```{r}
e$x <- factor(ifelse(e$age > 70, ">70", "<=70"), levels = c("<=70", ">70"))
plot(survfit(Surv(time, death_status) ~ I(age > 70), data = e),
     ylim = c(0.8, 1),
     col = 1:2)
```

## Age - piecewise-linear - B

Two segments: b1 for 0-70; b2 after 70

```{r}
e <-
  d_surv |>
  mutate(
    age_le70 = ifelse(age <= 70, age, 70),
    age_gt70 = ifelse(age <= 70, 0, age - 70)
  )
```

```{r}
with(e, table(age == (age_le70 + age_gt70)))
```


```{r}
fit_age_segments <- coxph(Surv(time, death_status) ~ age_le70 + age_gt70, data = e)
summary(fit_age_segments)
```

The positive effect of age on risk of death by Covid-19 is only statistically significant _after_ age=70.

```{r}
pl_age <- function(x) {
  cbind(
    age_le70 = ifelse(x <= 70, x, 70),
    age_gt70 = ifelse(x <= 70, 0, x - 70)
  )
}
pl_age(65:75)
```

```{r}
(b <- coef(fit_age_segments))
```

```{r}
linear_predictor <- function(age) {
  X <- pl_age(age)
  X %*% b
}
linear_predictor(65:75)
```

```{r}
curve(linear_predictor(x), from = 20, to = 100,
      lwd = 2,
      xlab = "Age (years)",
      ylab = "linear predictor")
abline(v = 70, lty = 2, lwd = 2)
```

